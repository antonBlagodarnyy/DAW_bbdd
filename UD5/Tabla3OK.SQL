REM ******** TABLA DEPART Y EMPLE: ***********

DROP TABLE DEPART cascade constraints; 

CREATE TABLE DEPART (
 DEPT_NO  NUMBER(2) CONSTRAINT pk_depart PRIMARY KEY,
 DNOMBRE  VARCHAR2(14), 
 LOC      VARCHAR2(14) ) ;

INSERT INTO DEPART VALUES (10,'CONTABILIDAD','SEVILLA');
INSERT INTO DEPART VALUES (20,'INVESTIGACION','MADRID');
INSERT INTO DEPART VALUES (30,'VENTAS','BARCELONA');
INSERT INTO DEPART VALUES (40,'PRODUCCION','BILBAO');
COMMIT;

ALTER SESSION SET NLS_DATE_FORMAT='DD/MM/YYYY';

DROP TABLE EMPLE cascade constraints; 

CREATE TABLE EMPLE (
 EMP_NO    NUMBER(4) CONSTRAINT pk_emple PRIMARY KEY,
 APELLIDO  VARCHAR2(10)  ,
 OFICIO    VARCHAR2(10)  ,
 DIR       NUMBER(4) ,
 FECHA_ALT DATE      ,
 SALARIO   NUMBER(7),
 COMISION  NUMBER(7),
 DEPT_NO   NUMBER(2) NOT NULL,
 CONSTRAINT fk_emple_depart FOREIGN KEY (dept_no) REFERENCES depart (dept_no)
) ;

INSERT INTO EMPLE VALUES (7369,'SANCHEZ','EMPLEADO',7902,'17/12/1990',1040,NULL,20);
INSERT INTO EMPLE VALUES (7499,'ARROYO','VENDEDOR',7698,'20/02/1990',1500,390,30);
INSERT INTO EMPLE VALUES (7521,'SALA','VENDEDOR',7698,'22/02/1991',1625,650,30);
INSERT INTO EMPLE VALUES (7566,'JIMENEZ','DIRECTOR',7839,'02/04/1991',2900,NULL,20);
INSERT INTO EMPLE VALUES (7654,'MARTIN','VENDEDOR',7698,'29/09/1991',1600,1020,30);
INSERT INTO EMPLE VALUES (7698,'NEGRO','DIRECTOR',7839,'01/05/1991',3005,NULL,30);
INSERT INTO EMPLE VALUES (7782,'CEREZO','DIRECTOR',7839,'09/06/1991',2885,NULL,10);
INSERT INTO EMPLE VALUES (7788,'GIL','ANALISTA',7566,'09/11/1991',3000,NULL,20);
INSERT INTO EMPLE VALUES (7839,'REY','PRESIDENTE',NULL,'17/11/1991',4100,NULL,10);
INSERT INTO EMPLE VALUES (7844,'TOVAR','VENDEDOR',7698,'08/09/1991',1350,0,30);
INSERT INTO EMPLE VALUES (7876,'ALONSO','EMPLEADO',7788,'23/09/1991',1430,NULL,20);
INSERT INTO EMPLE VALUES (7900,'JIMENO','EMPLEADO',7698,'03/12/1991',1335,NULL,30);
INSERT INTO EMPLE VALUES (7902,'FERNANDEZ','ANALISTA',7566,'03/12/1991',3000,NULL,20);
INSERT INTO EMPLE VALUES (7934,'MUÑOZ','EMPLEADO',7782,'23/01/1992',1690,NULL,10);
COMMIT;


REM ************ TABLA ALUM, NUEVOS, ANTIGUOS ************

DROP TABLE ALUM cascade constraints;
DROP TABLE NUEVOS cascade constraints;
DROP TABLE ANTIGUOS cascade constraints;

Create TABLE ALUM
(
  NOMBRE VARCHAR2(20),
 EDAD NUMBER(2),
 LOCALIDAD VARCHAR2(15)
) ;

Create TABLE  NUEVOS
(
  NOMBRE  VARCHAR2(20),
 EDAD NUMBER(2),
 LOCALIDAD VARCHAR2(15)
) ;

Create TABLE ANTIGUOS
(
  NOMBRE  VARCHAR2(20),
 EDAD NUMBER(2),
 LOCALIDAD VARCHAR2(15)
) ;

INSERT INTO ALUM VALUES('JUAN',18,'COSLADA');
INSERT INTO ALUM VALUES('PEDRO',19,'COSLADA');
INSERT INTO ALUM VALUES('ANA',17,'ALCALÁ');
INSERT INTO ALUM VALUES('LUISA',18,'TORREJÓN');
INSERT INTO ALUM VALUES('MARÍA',20,'MADRID');
INSERT INTO ALUM VALUES('ERNESTO',21,'MADRID');
INSERT INTO ALUM VALUES('RAQUEL',19,'TOLEDO');

INSERT INTO NUEVOS VALUES('JUAN',18,'COSLADA');
INSERT INTO NUEVOS VALUES('MAITE',15,'ALCALÁ');
INSERT INTO NUEVOS VALUES('SOFÍA',14,'ALCALÁ');
INSERT INTO NUEVOS VALUES('ANA',17,'ALCALA');
INSERT INTO NUEVOS VALUES('ERNESTO',21,'MADRID');

INSERT INTO ANTIGUOS VALUES('MARÍA',20,'MADRID');
INSERT INTO ANTIGUOS VALUES('ERNESTO',21,'MADRID');
INSERT INTO ANTIGUOS VALUES('ANDRÉS',26,'LAS ROZAS');
INSERT INTO ANTIGUOS VALUES('IRENE',24,'LAS ROZAS');

COMMIT;

REM ************ TABLA PERSONAL, PROFESORES, CENTROS ***********

DROP TABLE PERSONAL cascade constraints; 

CREATE TABLE PERSONAL (
 COD_CENTRO   NUMBER(4) NOT NULL,
 DNI NUMBER(10),
 APELLIDOS VARCHAR2(30),
 FUNCION VARCHAR2(15),
 SALARIO NUMBER (10) 
);

INSERT INTO PERSONAL VALUES (10,1112345,'Martínez Salas, Fernando','PROFESOR', 220000);
INSERT INTO PERSONAL VALUES (10,4123005,'Bueno Zarco, Elisa', 'PROFESOR', 220000);
INSERT INTO PERSONAL VALUES (10,4122025,'Montes García, M.Pilar', 'PROFESOR', 220000);
INSERT INTO PERSONAL VALUES (15,1112345,'Rivera Silvestre, Ana','PROFESOR', 205000);
INSERT INTO PERSONAL VALUES (15,9800990, 'Ramos Ruiz, Luis','PROFESOR', 205000);
INSERT INTO PERSONAL VALUES (15,8660990, 'De Lucas Fdez, M.Angel','PROFESOR', 205000);
INSERT INTO PERSONAL VALUES (22,7650000, 'Ruiz Lafuente, Manuel','PROFESOR', 220000);
INSERT INTO PERSONAL VALUES (45,43526789, 'Serrano Laguía, María','PROFESOR', 205000);
INSERT INTO PERSONAL VALUES (10,4480099,'Ruano Cerezo, Manuel','ADMINISTRATIVO', 180000);
INSERT INTO PERSONAL VALUES (15,1002345,'Albarrán Serrano, Alicia','ADMINISTRATIVO', 180000);
INSERT INTO PERSONAL VALUES (15,7002660,'Muñoz Rey, Felicia','ADMINISTRATIVO', 180000);
INSERT INTO PERSONAL VALUES (22,5502678,'Marín Marín, Pedro','ADMINISTRATIVO', 180000);
INSERT INTO PERSONAL VALUES (22,6600980, 'Peinado Gil, Elena','CONSERJE', 175000);
INSERT INTO PERSONAL VALUES (45,4163222, 'Sarro Molina, Carmen','CONSERJE', 175000);

DROP TABLE PROFESORES cascade constraints; 

CREATE TABLE PROFESORES (
 COD_CENTRO   NUMBER(4) NOT NULL,
 DNI          NUMBER(10),
 APELLIDOS VARCHAR2(30),
 ESPECIALIDAD VARCHAR2(16) 
) ;


INSERT INTO PROFESORES VALUES (10,1112345,'Martínez Salas, Fernando','INFORMÁTICA');
INSERT INTO PROFESORES VALUES (10,4123005,'Bueno Zarco, Elisa', 'MATEMÁTICAS');
INSERT INTO PROFESORES VALUES (10,4122025,'Montes García, M.Pilar', 'MATEMÁTICAS');
INSERT INTO PROFESORES VALUES (15,9800990, 'Ramos Ruiz, Luis','LENGUA');
INSERT INTO PROFESORES VALUES (15,1112345,'Rivera Silvestre, Ana','DIBUJO');
INSERT INTO PROFESORES VALUES (15,8660990, 'De Lucas Fdez, M.Angel','LENGUA');
INSERT INTO PROFESORES VALUES (22,7650000, 'Ruiz Lafuente, Manuel','MATEMÁTICAS');
INSERT INTO PROFESORES VALUES (45,43526789, 'Serrano Laguía, María','INFORMÁTICA');

DROP TABLE CENTROS cascade constraints; 

CREATE TABLE CENTROS (
 COD_CENTRO   NUMBER(4) NOT NULL,
 TIPO_CENTRO  CHAR(1),
 NOMBRE VARCHAR2(30),
 DIRECCION VARCHAR2(26),
 TELEFONO VARCHAR2(10),
 NUM_PLAZAS NUMBER(4)
 ) ;


INSERT INTO CENTROS VALUES (10,'S','IES El Quijote', 'Avda. Los Molinos 25', '965-887654',538);
INSERT INTO CENTROS VALUES (15,'P','CP Los Danzantes', 'C/Las Musas s/n','985-112322',250);
INSERT INTO CENTROS VALUES (22,'S', 'IES Planeta Tierra', 'C/Mina 45','925-443400',300);
INSERT INTO CENTROS VALUES (45,'P', 'CP Manuel Hidalgo', 'C/Granada 5','926-202310',220);
INSERT INTO CENTROS VALUES (50,'S', 'IES Antoñete', 'C/Los Toreros 21','989-406090',310);

commit;

REM *********************************************************
REM ***TABLAS BANCOS, SUCURSALES, CUENTAS Y MOVIMIENTOS. ***
REM ** BORRADO DE TABLAS *****

drop table bancos cascade constraints;
drop table sucursales cascade constraints;
drop table CUENTAS cascade constraints;
drop table MOVIMIENTOS Cascade constraints;


REM ***** CREACION DE TABLAS *****

Create TABLE   BANCOS(
COD_BANCO   NUMBER(4) CONSTRAINT pk_bancos PRIMARY KEY,
NF_BANCO    VARCHAR2(10),
NOMBRE_BANC VARCHAR2(30),
DOM_FISCAL  VARCHAR(35),
POBLACION   VARCHAR(35)
);


Create TABLE  SUCURSALES(
COD_BANCO   NUMBER(4),
COD_SUCUR   NUMBER (4),
NOMBRE_SUC  VARCHAR2(35),
DIREC_SUC   VARCHAR2(35),
LOC_SUC     VARCHAR2(20),
PROV_SUC    VARCHAR2(20),
CONSTRAINT pk_sucursales PRIMARY KEY (COD_BANCO,COD_SUCUR),
CONSTRAINT fk_sucur_banco FOREIGN KEY (COD_BANCO) REFERENCES bancos (COD_BANCO)
);	

Create TABLE   CUENTAS(
COD_BANCO   NUMBER(4),
COD_SUCUR   NUMBER(4),
NUM_CTA     NUMBER(10) ,
FECHA_ALTA  DATE,
NOMBRE_CTA  VARCHAR2(35),
DIREC_CTA   VARCHAR2(35),
POBLA_CTA   VARCHAR2(20),
SALDO_DEBE  NUMBER(10),
SALDO_HABER NUMBER(10),
CONSTRAINT pk_cuentas PRIMARY KEY (COD_BANCO,COD_SUCUR,NUM_CTA),
CONSTRAINT fk_cuentas_sucur FOREIGN KEY (COD_BANCO,COD_SUCUR) REFERENCES sucursales (COD_BANCO,COD_SUCUR )
);

CREATE TABLE  MOVIMIENTOS(
COD_BANCO   NUMBER(4),
COD_SUCUR   NUMBER(4),
NUM_CTA     NUMBER(10), 
FECHA_MOV   DATE,
TIPO_MOV    CHAR(1), 
IMPORTE     NUMBER(10),
CONSTRAINT pk_movimientos PRIMARY KEY (COD_BANCO,COD_SUCUR,NUM_CTA,FECHA_MOV,TIPO_MOV),
CONSTRAINT fk_MOV_cuentas FOREIGN KEY (COD_BANCO,COD_SUCUR,NUM_CTA) REFERENCES CUENTAS (COD_BANCO,COD_SUCUR,NUM_CTA )
);


REM BANCOS **************

INSERT INTO BANCOS VALUES(1111,'122322223','BANCO DE ESPAÑA','GRAN VIA','MADRID');
INSERT INTO BANCOS VALUES(1112,'222322223','BANCO DE GUADALAJARA','MAYOR', 
					'GUADALAJARA');
INSERT INTO BANCOS VALUES(1113,'322322223','BANCO POPULAR','LA PLAZA','TOLEDO');
INSERT INTO BANCOS VALUES(1114,'422322223','CAJA CM','RIO DULCE','ALBACETE');


REM SUCURSALES  **************

INSERT INTO sucursales VALUES(1111, 5000,'* SUCURSAL 1*', 'ANCHA 24', 
	'TOLEDO','TOLEDO');
INSERT INTO sucursales VALUES(1111, 5001,'* SUCURSAL 2*', 'PILON 33',
 'PASTRANA','GUADALAJARA');

INSERT INTO sucursales VALUES(1112, 6000,'* SUCURSAL 6000*', 'MAYOR 55',
 'ALCALA','ALCALA');

INSERT INTO sucursales VALUES(1113, 4000,'* SUCURSAL 4000*', 'ERAS 77',
 'ARANJUEZ','MADRID');



REM CUENTAS  ****************************

INSERT INTO CUENTAS VALUES(1111, 5000,123456789,SYSDATE -7, 'JUAN','TOLEDO',
		'TOLEDO', 0,0);
INSERT INTO CUENTAS VALUES(1111, 5000,123456788,SYSDATE -6, 'PEDRO','TOLEDO',
		'TOLEDO', 0,0);
INSERT INTO CUENTAS VALUES(1111, 5001,123456787,SYSDATE -100, 'ANA','GUADALAJARA',
		'GUADALAJARA', 0,0);
INSERT INTO CUENTAS VALUES(1111, 5001,123456786,SYSDATE -6, 'MANUEL','GUADALAJARA',
		'GUADALAJARA', 0,0);

INSERT INTO CUENTAS VALUES(1111, 5001,123456785,SYSDATE -230, 'ANDRES','ALCALA',
		'ALCALA', 0,0);

INSERT INTO CUENTAS VALUES(1112, 6000,33334444, SYSDATE,'ISABEL','MADRID', 
		'MADRID', 0,0);
INSERT INTO CUENTAS VALUES(1112, 6000,33334440, SYSDATE-140,'MARIA','MADRID', 
		'MADRID', 0,0);


REM MOVIMIENTOS  ****************************

INSERT INTO MOVIMIENTOS VALUES(1112, 6000,33334444, SYSDATE,'I', 1000); 
INSERT INTO MOVIMIENTOS VALUES(1112, 6000,33334444, SYSDATE-1,'I', 2000); 
INSERT INTO MOVIMIENTOS VALUES(1112, 6000,33334444, SYSDATE-2,'R', 100); 
INSERT INTO MOVIMIENTOS VALUES(1112, 6000,33334444, SYSDATE,'R', 5000); 

INSERT INTO MOVIMIENTOS VALUES(1112, 6000,33334440, SYSDATE,'R',200);
INSERT INTO MOVIMIENTOS VALUES(1112, 6000,33334440, SYSDATE-2,'I',200);

INSERT INTO MOVIMIENTOS VALUES(1111, 5000,123456789,SYSDATE -7, 'I',100);
INSERT INTO MOVIMIENTOS VALUES(1111, 5000,123456789,SYSDATE -5, 'R',200);
INSERT INTO MOVIMIENTOS VALUES(1111, 5000,123456789,SYSDATE -4, 'I',300);

INSERT INTO MOVIMIENTOS VALUES(1111, 5000,123456788,SYSDATE,'I',200);

INSERT INTO MOVIMIENTOS VALUES(1111, 5001,123456787,SYSDATE, 'R',198);

INSERT INTO MOVIMIENTOS VALUES(1111, 5001,123456786,SYSDATE,'I',998);

Commit;



REM CALCULO DE SALDOS ***************

UPDATE  CUENTAS C SET SALDO_DEBE  = (SELECT SUM(IMPORTE) FROM MOVIMIENTOS
WHERE TIPO_MOV='R' AND C.COD_BANCO= COD_BANCO AND C.COD_SUCUR=COD_SUCUR
AND C.NUM_CTA =NUM_CTA);

UPDATE  CUENTAS C SET SALDO_HABER  = (SELECT SUM(IMPORTE) FROM MOVIMIENTOS
WHERE TIPO_MOV='I' AND C.COD_BANCO= COD_BANCO AND C.COD_SUCUR=COD_SUCUR
AND C.NUM_CTA =NUM_CTA);

UPDATE  CUENTAS SET SALDO_DEBE =0 WHERE SALDO_DEBE IS NULL;
UPDATE  CUENTAS SET SALDO_HABER=0 WHERE SALDO_HABER IS NULL;

COMMIT;

REM ************ FIN ****************

--1
--a) 
SELECT * FROM alum0405;

--b) 
SELECT dni, nombre, apellidos, curso, nivel, clase FROM alum0405;

--c)
SELECT * FROM alum0405 WHERE poblacion='GUADALAJARA';

--d)
SELECT nombre, apellidos FROM alum0405 WHERE poblacion='GUADALAJARA';

--e) 
SELECT dni, nombre, apellidos, curso, nivel, clase FROM alum0405 ORDER BY nombre, apellidos;

--2
SELECT oficio FROM emple WHERE apellido='JIMENEZ';
SELECT salario FROM emple WHERE apellido='FERNANDEZ';
SELECT apellido, oficio, salario, fecha_alt FROM emple WHERE oficio='DIRECTOR' OR salario >=3000;


--13
SELECT tema, estante, ejemplares FROM libreria WHERE ejemplares BETWEEN 8 AND 15;

--14
SELECT * FROM libreria WHERE ejemplares BETWEEN 9 AND 20;
SELECT * FROM libreria WHERE ejemplares NOT BETWEEN 0 AND 8;

--16
SELECT tema FROM libreria WHERE ejemplares BETWEEN 0 AND 14;
SELECT tema FROM libreria WHERE ejemplares < 15 AND ejemplares > 20; --No sale

---GROUP BY, HAVING, ORDER BY

--1
SELECT dept_no , AVG(salario) FROM emple GROUP BY dept_no HAVING AVG(salario) > 2500 ORDER BY AVG(salario) DESC;

--2
SELECT oficio, COUNT (*) AS numero_empleados FROM emple 
GROUP BY oficio HAVING COUNT (*) > 3 ORDER BY numero_empleados;

--3
SELECT estante, SUM(ejemplares) AS total_ejemplares FROM libreria 
GROUP BY estante HAVING SUM(ejemplares) > 10 ORDER BY total_ejemplares DESC;

--4
SELECT curso, nivel, COUNT(*) AS numero_alumnos FROM alum0405 
GROUP BY curso, nivel HAVING COUNT (*) > 5 ORDER BY numero_alumnos;

--5
SELECT dnombre, MAX(salario) AS salario_maximo FROM depart JOIN emple ON depart.dept_no = emple.dept_no 
GROUP BY dnombre HAVING MAX(salario) >3000 ORDER BY salario_maximo DESC;

SELECT dept_no, MAX(salario) AS salario_maximo FROM emple 
GROUP BY dept_no HAVING MAX(salario) > 3000 ORDER BY salario_maximo DESC;

--6
SELECT dir, COUNT(*) AS empleados_direccion FROM emple
GROUP BY dir HAVING COUNT(*) > 2 ORDER BY empleados_direccion;

SELECT loc, COUNT(*) AS empleados_localidad FROM depart 
JOIN emple ON depart.dept_no = emple.dept_no 
GROUP BY loc HAVING COUNT(*) > 2 ORDER BY empleados_localidad;

SELECT * FROM emple;

--7
SELECT tema, SUM(ejemplares) AS total_ejemplares
FROM libreria GROUP BY tema HAVING SUM(ejemplares) > 20 
ORDER BY total_ejemplares DESC;

--8
SELECT clase, COUNT (*) AS numero_alumnos 
FROM alum0405 GROUP BY clase HAVING COUNT (*) > 4 
ORDER BY numero_alumnos;

--9
SELECT oficio, AVG(salario) AS salario_promedio 
FROM emple GROUP BY oficio HAVING AVG(salario) >2000 
ORDER BY salario_promedio DESC;

--10
SELECT dept_no, COUNT(*) AS empleados_dept
FROM emple GROUP BY dept_no HAVING COUNT (*) > 3 ORDER BY empleados_dept;

SELECT dnombre, COUNT (*) AS empleados_dept 
FROM depart JOIN emple ON depart.dept_no = emple.dept_no  
GROUP BY dnombre HAVING COUNT (*) > 3 ORDER BY empleados_dept;

--11
SELECT estante, SUM(ejemplares) AS total_ejemplares 
FROM libreria GROUP BY estante HAVING SUM(ejemplares) > 15 
ORDER BY total_ejemplares DESC;

--12
SELECT nivel, COUNT(*) AS alumnos_por_nivel 
FROM alum0405 GROUP BY nivel HAVING COUNT (*) > 3 
ORDER BY alumnos_por_nivel;

--13
SELECT dir, MAX(salario) AS salario_maximo
FROM emple GROUP BY dir HAVING MAX(salario) > 3500 
ORDER BY salario_maximo DESC;

SELECT loc, MAX(salario) AS salarioMaximo_localidad 
FROM depart JOIN emple ON depart.dept_no = emple.dept_no 
GROUP BY loc HAVING MAX(salario) > 3500 ORDER BY salarioMaximo_localidad DESC;

--14
SELECT oficio, COUNT(*) AS numEmpleados_oficio 
FROM emple GROUP BY oficio HAVING COUNT(*) > 2 
ORDER BY numEmpleados_oficio;

--15
SELECT tema, SUM(ejemplares) AS ejemplares_tema 
FROM libreria GROUP BY tema HAVING COUNT(*) > 25 
ORDER BY ejemplares_tema DESC;

--16
SELECT dept_no, dir, AVG(salario) AS salariopromedio_dept_loc
FROM emple GROUP BY dept_no, dir HAVING AVG(salario) > 2500 AND COUNT(*) > 2
ORDER BY salariopromedio_dept_loc DESC;

SELECT dnombre, loc, AVG(salario) AS salarioPromedio_dept_loc 
FROM depart JOIN emple ON depart.dept_no = emple.dept_no 
GROUP BY dnombre, loc HAVING AVG(salario) > 2500 AND COUNT(*) > 2
ORDER BY salarioPromedio_dept_loc DESC;

--17
SELECT oficio, dir, COUNT(*) AS numEmpleados FROM emple 
GROUP BY oficio, dir HAVING COUNT(*) > 1 AND MAX(salario) > 3000 
ORDER BY numEmpleados;

SELECT oficio, loc, COUNT(*) AS numEmpleados_oficio_localidad 
FROM emple JOIN depart ON depart.dept_no = emple.dept_no  
GROUP BY oficio, loc HAVING COUNT(*) > 1 AND MAX(salario) > 3000 
ORDER BY numEmpleados_oficio_localidad;

--18
SELECT estante, tema, SUM(ejemplares) AS totalEjemplares_estante_tema 
FROM libreria GROUP BY estante, tema HAVING SUM(ejemplares) > 10 AND SUM(ejemplares) <= 20 
ORDER BY totalEjemplares_estante_tema DESC;

--19
SELECT curso, nivel, clase, COUNT(*) AS alumnos_curso_nivel_clase  
FROM alum0405 GROUP BY curso, nivel, clase 
HAVING COUNT(*) > 2 AND SUM(faltas1+faltas2+faltas3) < 5
ORDER BY alumnos_curso_nivel_clase;

--20
SELECT dept_no, oficio, AVG(salario) AS salario_promedio
FROM emple GROUP BY dept_no, oficio 
HAVING COUNT(*) > 1 AND MAX(salario) > 3500 
ORDER BY salario_promedio DESC;


SELECT dnombre, oficio, AVG(salario) AS salarioProm_depart_oficio 
FROM depart JOIN emple ON depart.dept_no = emple.dept_no 
GROUP BY dnombre, oficio
HAVING COUNT(*) > 1 AND MAX(salario) > 3500 
ORDER BY salarioProm_depart_oficio DESC;
